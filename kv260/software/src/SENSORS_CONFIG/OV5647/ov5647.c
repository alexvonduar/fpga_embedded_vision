#include "ov5647.h"
#include <xil_types.h>
#include <stdio.h>
#include <xstatus.h>
#include "xiicps.h"
#include "xparameters.h"
#include "sleep.h"
#include <xil_printf.h>
#include "parameters.h"
#include "../I2c_transections.h"
#include "../init_camera.h"
#define IIC_OV5647_ADDR  	        0X36
struct reginfo cfg_ov5647_init_data[] =
{	
        {0x0100,0x00},
        {0x3035,0x11},
        {0x3036,0x69},
        {0x303c,0x11},
        {0x3821,0x07},
        {0x3820,0x41},
        {0x370c,0x0f},
        {0x3612,0x59},
        {0x3618,0x00},
        {0x5000,0x06},
        {0x5002,0x40},
        {0x5003,0x08},
        {0x5a00,0x08},
        {0x3000,0xff},
        {0x3001,0xff},
        {0x3002,0xff},
        {0x301d,0xf0},
        {0x3a18,0x00},
        {0x3a19,0xf8},
        {0x3c01,0x80},
        {0x3b07,0x0c},
        {0x380c,0x07},
        {0x380d,0x68},
        {0x380e,0x03},
        {0x380f,0xd8},
        {0x3814,0x31},
        {0x3815,0x31},
        {0x3708,0x64},
        {0x3709,0x52},
        {0x3808,0x05},
        {0x3809,0x00},
        {0x380a,0x03},
        {0x380b,0xc0},
        {0x3800,0x00},
        {0x3801,0x18},
        {0x3802,0x00},
        {0x3803,0x0e},
        {0x3804,0x0a},
        {0x3805,0x27},
        {0x3806,0x07},
        {0x3807,0x95},
        {0x3630,0x2e},
        {0x3632,0xe2},
        {0x3633,0x23},
        {0x3634,0x44},
        {0x3620,0x64},
        {0x3621,0xe0},
        {0x3600,0x37},
        {0x3704,0xa0},
        {0x3703,0x5a},
        {0x3715,0x78},
        {0x3717,0x01},
        {0x3731,0x02},
        {0x370b,0x60},
        {0x3705,0x1a},
        {0x3f05,0x02},
        {0x3f06,0x10},
        {0x3f01,0x0a},
        {0x3a08,0x01},
        {0x3a09,0x27},
        {0x3a0a,0x00},
        {0x3a0b,0xf6},
        {0x3a0d,0x04},
        {0x3a0e,0x03},
        {0x3a0f,0x58},
        {0x3a10,0x50},
        {0x3a1b,0x58},
        {0x3a1e,0x50},
        {0x3a11,0x60},
        {0x3a1f,0x28},
        {0x4001,0x02},
        {0x4004,0x02},
        {0x4000,0x09},
        {0x4050,0x6e},
        {0x4051,0x8f},
        {0x4837,0x17},
        {0x3503,0x03},
        {0x3501,0x44},
        {0x3502,0x80},
        {0x350a,0x00},
        {0x350b,0x7f},
        {0x5001,0x01},
        {0x5002,0x41},
        {0x5180,0x08},
        {0x5186,0x04},
        {0x5187,0x00},
        {0x5188,0x04},
        {0x5189,0x00},
        {0x518a,0x04},
        {0x518b,0x00},
        {0x5000,0x86},
        {0x5800,0x11},
        {0x5801,0x0a},
        {0x5802,0x09},
        {0x5803,0x09},
        {0x5804,0x0a},
        {0x5805,0x0f},
        {0x5806,0x07},
        {0x5807,0x05},
        {0x5808,0x03},
        {0x5809,0x03},
        {0x580a,0x05},
        {0x580b,0x07},
        {0x580c,0x05},
        {0x580d,0x02},
        {0x580e,0x00},
        {0x580f,0x00},
        {0x5810,0x02},
        {0x5811,0x05},
        {0x5812,0x05},
        {0x5813,0x02},
        {0x5814,0x00},
        {0x5815,0x00},
        {0x5816,0x01},
        {0x5817,0x05},
        {0x5818,0x08},
        {0x5819,0x05},
        {0x581a,0x03},
        {0x581b,0x03},
        {0x581c,0x04},
        {0x581d,0x07},
        {0x581e,0x10},
        {0x581f,0x0b},
        {0x5820,0x09},
        {0x5821,0x09},
        {0x5822,0x09},
        {0x5823,0x0e},
        {0x5824,0x28},
        {0x5825,0x1a},
        {0x5826,0x1a},
        {0x5827,0x1a},
        {0x5828,0x46},
        {0x5829,0x2a},
        {0x582a,0x26},
        {0x582b,0x44},
        {0x582c,0x26},
        {0x582d,0x2a},
        {0x582e,0x28},
        {0x582f,0x42},
        {0x5830,0x40},
        {0x5831,0x42},
        {0x5832,0x28},
        {0x5833,0x0a},
        {0x5834,0x16},
        {0x5835,0x44},
        {0x5836,0x26},
        {0x5837,0x2a},
        {0x5838,0x28},
        {0x5839,0x0a},
        {0x583a,0x0a},
        {0x583b,0x0a},
        {0x583c,0x26},
        {0x583d,0xbe},
        {0x0100,0x01},
        {0x3000,0x00},
        {0x3001,0x00},
        {0x3002,0x00},
        {0x3017,0xe0},
        {0x301c,0xfc},
        {0x3636,0x06},
        {0x3016,0x08},
        {0x3827,0xec},
        {0x3018,0x44},
        {0x3035,0x21},
        {0x3106,0xf5},
        {0x3034,0x18},
        {0x301c,0xf8},
        {SEQUENCE_END, 0x00}
};
struct reginfo cfg_ov5647_1920_1080p_30fps[] =
{       //1920 x 1080 @ 30fps
        {0x0100, 0x00},
        {0x3820, 0x00},
        {0x3821, 0x06},
        {0x3612, 0x5b},
        {0x3618, 0x04},
        {0x380c, 0x09},
        {0x380d, 0xe8},
        {0x380e, 0x04},
        {0x380f, 0x50},
        {0x3814, 0x11},
        {0x3815, 0x11},
        {0x3709, 0x12},
        {0x3808, 0x07},
        {0x3809, 0x80},
        {0x380a, 0x04},
        {0x380b, 0x38},
        {0x3801, 0x5c},
        {0x3802, 0x01},
        {0x3803, 0xb2},
        {0x3804, 0x08},
        {0x3805, 0xe3},
        {0x3806, 0x05},
        {0x3807, 0xf1},
        {0x3a09, 0x4b},
        {0x3a0a, 0x01},
        {0x3a0b, 0x13},
        {0x3a0d, 0x04},
        {0x3a0e, 0x03},
        {0x4004, 0x04},
        {0x4005, 0x18},
        {0x0100, 0x01},
        {0x4202, 0x18},
        {0x300D, 0x01},
		{SEQUENCE_END, 0x00}
};
struct reginfo cfg_ov5647_advanced_awb[] =
{
		// Enable Advanced AWB
		{0x3406 ,0x00},
		{0x5192 ,0x04},
		{0x5191 ,0xf8},
		{0x518d ,0x26},
		{0x518f ,0x42},
		{0x518e ,0x2b},
		{0x5190 ,0x42},
		{0x518b ,0xd0},
		{0x518c ,0xbd},
		{0x5187 ,0x18},
		{0x5188 ,0x18},
		{0x5189 ,0x56},
		{0x518a ,0x5c},
		{0x5186 ,0x1c},
		{0x5181 ,0x50},
		{0x5184 ,0x20},
		{0x5182 ,0x11},
		{0x5183 ,0x00},
		{0x5001 ,0x03},
		{SEQUENCE_END, 0x00}
};
int ov5647_read(XIicPs *IicInstance,u16 addr,u8 *read_buf)
{
	*read_buf=i2c_reg16_read(IicInstance,IIC_OV5647_ADDR,addr);
	return XST_SUCCESS;
}

int ov5647_write(XIicPs *IicInstance,u16 addr,u8 data)
{
	return i2c_reg16_write(IicInstance,IIC_OV5647_ADDR,addr,data);
}
int ov5647_soft_write(XIicPs *IicInstance,u16 addr,u8 data)
{
	return i2c_reg16_write(IicInstance,0x74,addr,data);
}
void ov5647_sensor_write_array(XIicPs *IicInstance, struct reginfo *regarray)
{
	int i = 0;
	while (regarray[i].reg != SEQUENCE_END) {
		ov5647_write(IicInstance,regarray[i].reg,regarray[i].val);
		i++;
	}
}
int ov5647_camera_sensor_init(XIicPs *IicInstance)
{
	u8 sensor_id[2] ;
	ov5647_read(IicInstance, 0x300A, &sensor_id[0]);
	ov5647_read(IicInstance, 0x300B, &sensor_id[1]);
	if (sensor_id[0] == 0x56 || sensor_id[1] == 0x47)
	{
    xil_printf("Got OV5647 id: %x %x\r\n", sensor_id[0], sensor_id[1]);
	//[1]=0 System input clock from pad; Default read = 0x11
	//ov5647_write(IicInstance,0x3103,0x11);
	//[7]=1 Software reset; [6]=0 Software power down; Default=0x02
	ov5647_write(IicInstance,0x0103, 0x01);
	usleep(1000000);
	ov5647_sensor_write_array(IicInstance,cfg_ov5647_init_data);
	usleep(1000000);
	//[7]=0 Software reset; [6]=1 Software power down; Default=0x02
	ov5647_write(IicInstance,0x3008, 0x42);

	ov5647_sensor_write_array(IicInstance,cfg_ov5647_1920_1080p_30fps);


	//ov5647_sensor_write_array(IicInstance,cfg_ov5647_advanced_awb);
	//[7]=0 Software reset; [6]=0 Software power down; Default=0x02
	//ov5647_write(IicInstance,0x3008, 0x02);
	}
	return 0;
}
